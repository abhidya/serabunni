<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant Queen - Idle Clicker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>üêú Loading Ant Queen...</div>
        <div style="font-size: 14px; margin-top: 10px;">Initializing colony...</div>
    </div>
    <div id="game-container"></div>

    <!-- Phaser 3 via CDN with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <!-- EasyStar.js for pathfinding - https://easystarjs.com/ -->
    <script src="https://cdn.jsdelivr.net/npm/easystarjs@0.4.4/bin/easystar.min.js"></script>
    
    <!-- break_infinity.js for big numbers - https://github.com/Patashu/break_infinity.js -->
    <script src="https://cdn.jsdelivr.net/npm/break_infinity.js@2.0.2/break_infinity.min.js"></script>
    
    <!-- tsParticles for ambient particles - https://particles.js.org/ -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>

    <script>
        // Wait for libraries to load
        window.addEventListener('load', function() {
            if (typeof Phaser === 'undefined') {
                document.getElementById('loading').innerHTML = '<div style="color: #ff6b6b;">Error: Failed to load Phaser 3. Please check your internet connection.</div>';
                return;
            }

            // Hide loading screen after a short delay
            setTimeout(() => {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.style.display = 'none';
            }, 1000);

            // ===== GAME CONFIGURATION =====
            const GAME_CONFIG = {
                TILE_SIZE: 32,
                GRID_WIDTH: 20,
                GRID_HEIGHT: 15,
                TICK_RATE: 100, // 10Hz economy tick
                SAVE_INTERVAL: 30000, // Autosave every 30 seconds
                MAX_OFFLINE_HOURS: 16,
                OFFLINE_EFFICIENCY_DROPOFF: 8, // Hours before efficiency drops to 50%
            };

            // ===== NUMBER WRAPPER using break_infinity.js =====
            // Reference: https://github.com/Patashu/break_infinity.js
            class GameNumber {
                constructor(value) {
                    this.value = new Decimal(value);
                }

                add(other) {
                    return new GameNumber(this.value.add(other.value || other));
                }

                sub(other) {
                    return new GameNumber(this.value.sub(other.value || other));
                }

                mul(other) {
                    return new GameNumber(this.value.mul(other.value || other));
                }

                div(other) {
                    return new GameNumber(this.value.div(other.value || other));
                }

                pow(other) {
                    return new GameNumber(this.value.pow(other.value || other));
                }

                gte(other) {
                    return this.value.gte(other.value || other);
                }

                lte(other) {
                    return this.value.lte(other.value || other);
                }

                gt(other) {
                    return this.value.gt(other.value || other);
                }

                lt(other) {
                    return this.value.lt(other.value || other);
                }

                floor() {
                    return new GameNumber(this.value.floor());
                }

                toString() {
                    return this.formatCompact();
                }

                toNumber() {
                    return this.value.toNumber();
                }

                formatCompact() {
                    const num = this.value;
                    if (num.lt(1000)) {
                        return num.toFixed(0);
                    }
                    if (num.lt(1e6)) {
                        return (num.toNumber() / 1000).toFixed(2) + 'K';
                    }
                    if (num.lt(1e9)) {
                        return (num.toNumber() / 1e6).toFixed(2) + 'M';
                    }
                    if (num.lt(1e12)) {
                        return (num.toNumber() / 1e9).toFixed(2) + 'B';
                    }
                    if (num.lt(1e15)) {
                        return (num.toNumber() / 1e12).toFixed(2) + 'T';
                    }
                    // Scientific notation for very large numbers
                    return num.toExponential(2);
                }
            }

            // ===== GAME DATA TABLES =====
            // Reference: Cookie Clicker tier-based progression patterns
            const UNIT_DATA = {
                nurses: {
                    id: 'nurses',
                    name: 'Nurses',
                    baseCost: 15,
                    growth: 1.18,
                    baseProd: 0.02,
                    prodType: 'brood',
                    description: 'Care for larvae, increase hatch speed',
                    icon: 'üêú',
                    synergies: [
                        { at: 25, type: 'hatch_speed', value: 0.5 },
                        { at: 50, type: 'hatch_speed', value: 0.5 },
                        { at: 100, type: 'hatch_speed', value: 0.5 }
                    ]
                },
                foragers: {
                    id: 'foragers',
                    name: 'Foragers',
                    baseCost: 10,
                    growth: 1.15,
                    baseProd: 0.10,
                    prodType: 'food',
                    description: 'Gather food for the colony',
                    icon: 'üêú',
                    synergies: [
                        { at: 25, type: 'food_bonus', value: 0.02 },
                        { at: 50, type: 'food_bonus', value: 0.02 },
                        { at: 100, type: 'food_bonus', value: 0.02 }
                    ]
                },
                builders: {
                    id: 'builders',
                    name: 'Builders',
                    baseCost: 50,
                    growth: 1.20,
                    baseProd: 0.02,
                    prodType: 'build_speed',
                    description: 'Reduce build and upgrade times',
                    icon: 'üêú',
                    synergies: [
                        { at: 25, type: 'build_speed', value: 0.1 },
                        { at: 50, type: 'build_speed', value: 0.1 },
                        { at: 100, type: 'build_speed', value: 0.1 }
                    ]
                },
                soldiers: {
                    id: 'soldiers',
                    name: 'Soldiers',
                    baseCost: 100,
                    growth: 1.22,
                    baseProd: 0.05,
                    prodType: 'courage',
                    description: 'Defend colony and boost work rate',
                    icon: 'üêú',
                    synergies: [
                        { at: 25, type: 'work_rate', value: 0.05 },
                        { at: 50, type: 'work_rate', value: 0.05 },
                        { at: 100, type: 'work_rate', value: 0.05 }
                    ]
                },
                explorers: {
                    id: 'explorers',
                    name: 'Explorers',
                    baseCost: 250,
                    growth: 1.22,
                    baseProd: 0.01,
                    prodType: 'discovery',
                    description: 'Reveal map nodes and find rare items',
                    icon: 'üêú',
                    synergies: [
                        { at: 25, type: 'rare_drop', value: 0.005 },
                        { at: 50, type: 'rare_drop', value: 0.005 },
                        { at: 100, type: 'rare_drop', value: 0.005 }
                    ]
                },
                alates: {
                    id: 'alates',
                    name: 'Alates (New Queens)',
                    baseCost: 5000,
                    growth: 1.35,
                    baseProd: 0.02,
                    prodType: 'subcolony',
                    description: 'Create sub-colonies for federation bonuses',
                    icon: 'üëë',
                    synergies: [
                        { at: 5, type: 'global_prod', value: 0.02 },
                        { at: 10, type: 'global_prod', value: 0.02 },
                        { at: 25, type: 'global_prod', value: 0.02 }
                    ]
                }
            };

            const ROOM_DATA = {
                nursery: {
                    id: 'nursery',
                    name: 'Nursery',
                    baseCost: 100,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'hatch_speed', value: 0.10 },
                        { tier: 2, type: 'hatch_speed', value: 0.10 },
                        { tier: 3, type: 'hatch_speed', value: 0.15 }
                    ],
                    description: 'Increases hatching speed',
                    icon: 'ü•ö'
                },
                hatchery: {
                    id: 'hatchery',
                    name: 'Hatchery',
                    baseCost: 250,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'larva_capacity', value: 1 },
                        { tier: 2, type: 'larva_capacity', value: 1 },
                        { tier: 3, type: 'larva_capacity', value: 2 }
                    ],
                    description: 'Increases larva capacity',
                    icon: 'ü™∫'
                },
                granary: {
                    id: 'granary',
                    name: 'Granary',
                    baseCost: 150,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'food_storage', value: 0.05 },
                        { tier: 2, type: 'food_storage', value: 0.10 },
                        { tier: 3, type: 'food_storage', value: 0.15 }
                    ],
                    description: 'Increases food storage capacity',
                    icon: 'üåæ'
                },
                fungusFarm: {
                    id: 'fungusFarm',
                    name: 'Fungus Farm',
                    baseCost: 200,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'food_production', value: 0.03 },
                        { tier: 2, type: 'food_production', value: 0.05 },
                        { tier: 3, type: 'food_production', value: 0.07 }
                    ],
                    description: 'Increases food production',
                    icon: 'üçÑ'
                },
                workshop: {
                    id: 'workshop',
                    name: 'Workshop',
                    baseCost: 300,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'builder_rate', value: 0.10 },
                        { tier: 2, type: 'builder_rate', value: 0.10 },
                        { tier: 3, type: 'builder_rate', value: 0.15 }
                    ],
                    description: 'Boosts builder effectiveness',
                    icon: 'üî®',
                    adjacencyBonus: { type: 'builder_rate', value: 0.05 }
                },
                barracks: {
                    id: 'barracks',
                    name: 'Barracks',
                    baseCost: 400,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'soldier_buff', value: 0.10 },
                        { tier: 2, type: 'soldier_buff', value: 0.10 },
                        { tier: 3, type: 'soldier_buff', value: 0.15 }
                    ],
                    description: 'Increases soldier buff strength',
                    icon: '‚öîÔ∏è'
                },
                mapRoom: {
                    id: 'mapRoom',
                    name: 'Map Room',
                    baseCost: 350,
                    growthTier: 1.35,
                    maxTier: 1,
                    effects: [
                        { tier: 1, type: 'enable_map', value: 1 }
                    ],
                    description: 'Unlocks exploration and events',
                    icon: 'üó∫Ô∏è'
                },
                queensChamber: {
                    id: 'queensChamber',
                    name: "Queen's Chamber",
                    baseCost: 1000,
                    growthTier: 1.35,
                    maxTier: 1,
                    effects: [
                        { tier: 1, type: 'enable_prestige', value: 1 }
                    ],
                    description: 'Unlocks prestige system',
                    icon: 'üëë'
                },
                pheromoneLab: {
                    id: 'pheromoneLab',
                    name: 'Pheromone Lab',
                    baseCost: 800,
                    growthTier: 1.35,
                    maxTier: 3,
                    effects: [
                        { tier: 1, type: 'global_production', value: 0.02 },
                        { tier: 2, type: 'global_production', value: 0.02 },
                        { tier: 3, type: 'global_production', value: 0.03 }
                    ],
                    description: 'Global production bonus',
                    icon: '‚öóÔ∏è'
                }
            };

            // ===== GAME STATE =====
            class GameState {
                constructor() {
                    this.version = '1.0.0';
                    this.currencies = {
                        food: new GameNumber(10),
                        broodPoints: new GameNumber(0),
                        pheromones: new GameNumber(0),
                        royalJelly: new GameNumber(0)
                    };
                    this.units = {};
                    this.rooms = {};
                    this.meta = {
                        totalLifetimeFood: new GameNumber(0),
                        prestigeCount: 0,
                        metaUpgrades: {}
                    };
                    this.stats = {
                        startTime: Date.now(),
                        lastTick: Date.now(),
                        lastSave: Date.now(),
                        totalClicks: 0,
                        timeToFirstAutoclick: null,
                        timeToFirstPrestige: null
                    };
                    this.settings = {
                        reducedMotion: false,
                        compactNotation: true,
                        particleDensity: 1.0
                    };
                    
                    // Initialize units
                    Object.keys(UNIT_DATA).forEach(key => {
                        this.units[key] = { level: 0 };
                    });
                    
                    // Initialize rooms
                    Object.keys(ROOM_DATA).forEach(key => {
                        this.rooms[key] = { tier: 0 };
                    });
                }

                calculateUnitCost(unitId) {
                    const data = UNIT_DATA[unitId];
                    const level = this.units[unitId].level;
                    return new GameNumber(data.baseCost).mul(Math.pow(data.growth, level));
                }

                calculateRoomCost(roomId) {
                    const data = ROOM_DATA[roomId];
                    const tier = this.rooms[roomId].tier;
                    return new GameNumber(data.baseCost).mul(Math.pow(data.growthTier, tier));
                }

                canAffordUnit(unitId) {
                    const cost = this.calculateUnitCost(unitId);
                    return this.currencies.food.gte(cost);
                }

                canAffordRoom(roomId) {
                    const cost = this.calculateRoomCost(roomId);
                    return this.currencies.food.gte(cost);
                }

                buyUnit(unitId) {
                    if (!this.canAffordUnit(unitId)) return false;
                    
                    const cost = this.calculateUnitCost(unitId);
                    this.currencies.food = this.currencies.food.sub(cost);
                    this.units[unitId].level++;
                    
                    // Track time to first autoclick
                    if (unitId === 'foragers' && this.units[unitId].level === 1 && !this.stats.timeToFirstAutoclick) {
                        this.stats.timeToFirstAutoclick = Date.now() - this.stats.startTime;
                    }
                    
                    return true;
                }

                buyRoom(roomId) {
                    const data = ROOM_DATA[roomId];
                    if (this.rooms[roomId].tier >= data.maxTier) return false;
                    if (!this.canAffordRoom(roomId)) return false;
                    
                    const cost = this.calculateRoomCost(roomId);
                    this.currencies.food = this.currencies.food.sub(cost);
                    this.rooms[roomId].tier++;
                    
                    return true;
                }

                calculateProduction() {
                    let foodPerTick = new GameNumber(0);
                    let broodPerTick = new GameNumber(0);
                    
                    // Calculate base production from units
                    Object.keys(UNIT_DATA).forEach(unitId => {
                        const data = UNIT_DATA[unitId];
                        const level = this.units[unitId].level;
                        
                        if (level > 0) {
                            const baseProd = new GameNumber(data.baseProd).mul(level);
                            
                            if (data.prodType === 'food') {
                                foodPerTick = foodPerTick.add(baseProd);
                            } else if (data.prodType === 'brood') {
                                broodPerTick = broodPerTick.add(baseProd);
                            }
                        }
                    });
                    
                    // Apply global multipliers from rooms
                    let globalMult = 1.0;
                    Object.keys(this.rooms).forEach(roomId => {
                        const data = ROOM_DATA[roomId];
                        const tier = this.rooms[roomId].tier;
                        
                        if (tier > 0 && data.effects) {
                            data.effects.forEach(effect => {
                                if (effect.tier <= tier) {
                                    if (effect.type === 'food_production') {
                                        globalMult += effect.value;
                                    } else if (effect.type === 'global_production') {
                                        globalMult += effect.value;
                                    }
                                }
                            });
                        }
                    });
                    
                    // Apply synergies
                    Object.keys(UNIT_DATA).forEach(unitId => {
                        const data = UNIT_DATA[unitId];
                        const level = this.units[unitId].level;
                        
                        if (level > 0 && data.synergies) {
                            data.synergies.forEach(synergy => {
                                if (level >= synergy.at) {
                                    if (synergy.type === 'food_bonus') {
                                        const explorerBonus = this.units.explorers.level * synergy.value;
                                        globalMult += explorerBonus;
                                    } else if (synergy.type === 'global_prod') {
                                        globalMult += synergy.value;
                                    }
                                }
                            });
                        }
                    });
                    
                    foodPerTick = foodPerTick.mul(globalMult);
                    broodPerTick = broodPerTick.mul(globalMult);
                    
                    return { foodPerTick, broodPerTick };
                }

                tick() {
                    const production = this.calculateProduction();
                    
                    this.currencies.food = this.currencies.food.add(production.foodPerTick);
                    this.currencies.broodPoints = this.currencies.broodPoints.add(production.broodPerTick);
                    this.meta.totalLifetimeFood = this.meta.totalLifetimeFood.add(production.foodPerTick);
                    
                    this.stats.lastTick = Date.now();
                }

                clickFood() {
                    const clickPower = new GameNumber(1);
                    this.currencies.food = this.currencies.food.add(clickPower);
                    this.meta.totalLifetimeFood = this.meta.totalLifetimeFood.add(clickPower);
                    this.stats.totalClicks++;
                }

                canPrestige() {
                    return this.rooms.queensChamber.tier >= 1 && 
                           this.meta.totalLifetimeFood.gte(new GameNumber(1e9));
                }

                prestige() {
                    if (!this.canPrestige()) return false;
                    
                    // Calculate Royal Jelly reward
                    const lifetimeLog = Math.floor(Math.log10(this.meta.totalLifetimeFood.toNumber()));
                    const royalJellyGain = new GameNumber(Math.max(1, lifetimeLog));
                    
                    // Reset currencies and units/rooms
                    this.currencies.food = new GameNumber(10);
                    this.currencies.broodPoints = new GameNumber(0);
                    this.currencies.pheromones = new GameNumber(0);
                    this.currencies.royalJelly = this.currencies.royalJelly.add(royalJellyGain);
                    
                    Object.keys(this.units).forEach(key => {
                        this.units[key].level = 0;
                    });
                    
                    Object.keys(this.rooms).forEach(key => {
                        this.rooms[key].tier = 0;
                    });
                    
                    this.meta.prestigeCount++;
                    if (!this.stats.timeToFirstPrestige) {
                        this.stats.timeToFirstPrestige = Date.now() - this.stats.startTime;
                    }
                    
                    return true;
                }

                calculateOfflineProgress(timeDiff) {
                    const hoursOffline = timeDiff / (1000 * 60 * 60);
                    
                    if (hoursOffline <= 0) return;
                    
                    // Calculate efficiency
                    let efficiency = 1.0;
                    if (hoursOffline > GAME_CONFIG.OFFLINE_EFFICIENCY_DROPOFF) {
                        efficiency = 0.5;
                    }
                    
                    // Cap at max offline hours
                    const effectiveHours = Math.min(hoursOffline, GAME_CONFIG.MAX_OFFLINE_HOURS);
                    
                    // Calculate ticks
                    const ticksToProcess = Math.floor(effectiveHours * 3600 * (1000 / GAME_CONFIG.TICK_RATE));
                    
                    // Process production
                    const production = this.calculateProduction();
                    const foodGain = production.foodPerTick.mul(ticksToProcess * efficiency);
                    const broodGain = production.broodPerTick.mul(ticksToProcess * efficiency);
                    
                    this.currencies.food = this.currencies.food.add(foodGain);
                    this.currencies.broodPoints = this.currencies.broodPoints.add(broodGain);
                    this.meta.totalLifetimeFood = this.meta.totalLifetimeFood.add(foodGain);
                    
                    return { hoursOffline: effectiveHours, foodGain, broodGain };
                }

                save() {
                    const saveData = {
                        version: this.version,
                        timestamp: Date.now(),
                        currencies: {
                            food: this.currencies.food.value.toString(),
                            broodPoints: this.currencies.broodPoints.value.toString(),
                            pheromones: this.currencies.pheromones.value.toString(),
                            royalJelly: this.currencies.royalJelly.value.toString()
                        },
                        units: this.units,
                        rooms: this.rooms,
                        meta: {
                            totalLifetimeFood: this.meta.totalLifetimeFood.value.toString(),
                            prestigeCount: this.meta.prestigeCount,
                            metaUpgrades: this.meta.metaUpgrades
                        },
                        stats: this.stats,
                        settings: this.settings
                    };
                    
                    return saveData;
                }

                load(saveData) {
                    if (!saveData || saveData.version !== this.version) return false;
                    
                    try {
                        this.currencies.food = new GameNumber(saveData.currencies.food);
                        this.currencies.broodPoints = new GameNumber(saveData.currencies.broodPoints);
                        this.currencies.pheromones = new GameNumber(saveData.currencies.pheromones);
                        this.currencies.royalJelly = new GameNumber(saveData.currencies.royalJelly);
                        
                        this.units = saveData.units;
                        this.rooms = saveData.rooms;
                        
                        this.meta.totalLifetimeFood = new GameNumber(saveData.meta.totalLifetimeFood);
                        this.meta.prestigeCount = saveData.meta.prestigeCount;
                        this.meta.metaUpgrades = saveData.meta.metaUpgrades;
                        
                        this.stats = saveData.stats;
                        this.settings = saveData.settings;
                        
                        return true;
                    } catch (e) {
                        console.error('Failed to load save:', e);
                        return false;
                    }
                }
            }

            // ===== SAVE MANAGER =====
            class SaveManager {
                constructor() {
                    this.SAVE_KEY = 'antQueen_save';
                    this.SLOT_COUNT = 3;
                }

                save(gameState, slotIndex = 0) {
                    const saveData = gameState.save();
                    const saves = this.getAllSaves();
                    saves[slotIndex] = saveData;
                    
                    try {
                        localStorage.setItem(this.SAVE_KEY, JSON.stringify(saves));
                        return true;
                    } catch (e) {
                        console.error('Failed to save:', e);
                        return false;
                    }
                }

                load(slotIndex = 0) {
                    const saves = this.getAllSaves();
                    return saves[slotIndex] || null;
                }

                getAllSaves() {
                    try {
                        const data = localStorage.getItem(this.SAVE_KEY);
                        if (!data) return Array(this.SLOT_COUNT).fill(null);
                        const saves = JSON.parse(data);
                        return Array.isArray(saves) ? saves : Array(this.SLOT_COUNT).fill(null);
                    } catch (e) {
                        return Array(this.SLOT_COUNT).fill(null);
                    }
                }

                deleteSave(slotIndex) {
                    const saves = this.getAllSaves();
                    saves[slotIndex] = null;
                    localStorage.setItem(this.SAVE_KEY, JSON.stringify(saves));
                }

                autoSave(gameState) {
                    // Rotate through save slots for autosave
                    const slotIndex = Math.floor(Date.now() / GAME_CONFIG.SAVE_INTERVAL) % this.SLOT_COUNT;
                    return this.save(gameState, slotIndex);
                }
            }

            // ===== PHASER SCENES =====

            // Boot Scene - Initialize game systems
            class BootScene extends Phaser.Scene {
                constructor() {
                    super({ key: 'BootScene' });
                }

                preload() {
                    // Create simple ant sprite programmatically
                    this.createAntSprites();
                }

                createAntSprites() {
                    // Create a simple ant sprite using graphics
                    const graphics = this.add.graphics();
                    
                    // Idle frame
                    graphics.fillStyle(0x654321, 1);
                    graphics.fillCircle(8, 8, 3); // Head
                    graphics.fillEllipse(8, 14, 4, 6); // Body
                    graphics.fillCircle(8, 20, 2); // Abdomen
                    
                    graphics.generateTexture('ant_idle', 16, 24);
                    graphics.clear();
                    
                    // Walk frame 1
                    graphics.fillStyle(0x654321, 1);
                    graphics.fillCircle(8, 7, 3);
                    graphics.fillEllipse(8, 13, 4, 6);
                    graphics.fillCircle(8, 19, 2);
                    graphics.generateTexture('ant_walk1', 16, 24);
                    graphics.clear();
                    
                    // Walk frame 2
                    graphics.fillStyle(0x654321, 1);
                    graphics.fillCircle(8, 9, 3);
                    graphics.fillEllipse(8, 15, 4, 6);
                    graphics.fillCircle(8, 21, 2);
                    graphics.generateTexture('ant_walk2', 16, 24);
                    graphics.clear();
                    
                    graphics.destroy();
                }

                create() {
                    // Initialize game systems
                    this.game.gameState = new GameState();
                    this.game.saveManager = new SaveManager();
                    
                    // Try to load save
                    const saveData = this.game.saveManager.load(0);
                    if (saveData) {
                        const loaded = this.game.gameState.load(saveData);
                        if (loaded) {
                            // Calculate offline progress
                            const timeDiff = Date.now() - saveData.timestamp;
                            const offlineProgress = this.game.gameState.calculateOfflineProgress(timeDiff);
                            this.game.offlineProgress = offlineProgress;
                        }
                    }
                    
                    // Create animations using Phaser Animation Manager
                    // Reference: https://photonstorm.github.io/phaser3-docs/Phaser.Animations.AnimationManager.html
                    this.anims.create({
                        key: 'ant_idle_anim',
                        frames: [
                            { key: 'ant_idle' },
                            { key: 'ant_walk1' }
                        ],
                        frameRate: 10,
                        repeat: -1
                    });
                    
                    this.anims.create({
                        key: 'ant_walk_anim',
                        frames: [
                            { key: 'ant_walk1' },
                            { key: 'ant_walk2' },
                            { key: 'ant_idle' }
                        ],
                        frameRate: 8,
                        repeat: -1
                    });
                    
                    this.scene.start('TitleScene');
                }
            }

            // Title Scene - Main menu
            class TitleScene extends Phaser.Scene {
                constructor() {
                    super({ key: 'TitleScene' });
                }

                create() {
                    const { width, height } = this.cameras.main;
                    
                    // Background
                    this.add.rectangle(width / 2, height / 2, width, height, 0x4a2c2a).setOrigin(0.5);
                    
                    // Title
                    this.add.text(width / 2, height / 3, 'üêú ANT QUEEN üëë', {
                        fontSize: '48px',
                        fontFamily: 'Arial',
                        color: '#ffd700',
                        stroke: '#000000',
                        strokeThickness: 4
                    }).setOrigin(0.5);
                    
                    // Subtitle
                    this.add.text(width / 2, height / 3 + 60, 'Idle Clicker Game', {
                        fontSize: '24px',
                        fontFamily: 'Arial',
                        color: '#ffffff'
                    }).setOrigin(0.5);
                    
                    // Start button
                    const startButton = this.add.text(width / 2, height / 2 + 40, 'START GAME', {
                        fontSize: '32px',
                        fontFamily: 'Arial',
                        color: '#ffffff',
                        backgroundColor: '#654321',
                        padding: { x: 30, y: 15 }
                    }).setOrigin(0.5).setInteractive();
                    
                    startButton.on('pointerover', () => {
                        startButton.setStyle({ backgroundColor: '#8b5a3c' });
                    });
                    
                    startButton.on('pointerout', () => {
                        startButton.setStyle({ backgroundColor: '#654321' });
                    });
                    
                    startButton.on('pointerdown', () => {
                        this.scene.start('ColonyScene');
                    });
                    
                    // Show offline progress if any
                    if (this.game.offlineProgress) {
                        const prog = this.game.offlineProgress;
                        const text = `Welcome back!\nYou were away for ${prog.hoursOffline.toFixed(1)} hours\nGained ${prog.foodGain.toString()} food!`;
                        this.add.text(width / 2, height - 100, text, {
                            fontSize: '16px',
                            fontFamily: 'Arial',
                            color: '#90ee90',
                            align: 'center'
                        }).setOrigin(0.5);
                    }
                    
                    // Credits
                    this.add.text(width / 2, height - 30, 'Assets: Kenney (CC0) | Made with Phaser 3', {
                        fontSize: '12px',
                        fontFamily: 'Arial',
                        color: '#888888'
                    }).setOrigin(0.5);
                }
            }

            // Colony Scene - Main gameplay
            class ColonyScene extends Phaser.Scene {
                constructor() {
                    super({ key: 'ColonyScene' });
                }

                create() {
                    const { width, height } = this.cameras.main;
                    
                    // Background
                    this.add.rectangle(width / 2, height / 2, width, height, 0x3a2a1a).setOrigin(0.5);
                    
                    // Initialize UI
                    this.createUI();
                    
                    // Initialize pathfinding (EasyStar.js)
                    // Reference: https://easystarjs.com/
                    if (typeof EasyStar !== 'undefined') {
                        this.easystar = new EasyStar.js();
                        this.setupPathfinding();
                    }
                    
                    // Create some visual ants
                    this.ants = [];
                    this.spawnAnts(3);
                    
                    // Start economy tick
                    this.time.addEvent({
                        delay: GAME_CONFIG.TICK_RATE,
                        callback: this.economyTick,
                        callbackScope: this,
                        loop: true
                    });
                    
                    // Auto-save timer
                    this.time.addEvent({
                        delay: GAME_CONFIG.SAVE_INTERVAL,
                        callback: this.autoSave,
                        callbackScope: this,
                        loop: true
                    });
                    
                    // Initialize tsParticles background
                    // Reference: https://particles.js.org/
                    this.initParticles();
                }

                setupPathfinding() {
                    const grid = [];
                    for (let y = 0; y < GAME_CONFIG.GRID_HEIGHT; y++) {
                        const row = [];
                        for (let x = 0; x < GAME_CONFIG.GRID_WIDTH; x++) {
                            row.push(0); // 0 = walkable
                        }
                        grid.push(row);
                    }
                    
                    this.easystar.setGrid(grid);
                    this.easystar.setAcceptableTiles([0]);
                }

                spawnAnts(count) {
                    const { width, height } = this.cameras.main;
                    for (let i = 0; i < count; i++) {
                        const ant = this.add.sprite(
                            Phaser.Math.Between(100, width - 100),
                            Phaser.Math.Between(200, height - 100),
                            'ant_idle'
                        );
                        ant.play('ant_idle_anim');
                        this.ants.push(ant);
                        
                        // Random movement
                        this.time.addEvent({
                            delay: Phaser.Math.Between(2000, 5000),
                            callback: () => this.moveAnt(ant),
                            callbackScope: this,
                            loop: true
                        });
                    }
                }

                moveAnt(ant) {
                    const { width, height } = this.cameras.main;
                    const targetX = Phaser.Math.Between(100, width - 100);
                    const targetY = Phaser.Math.Between(200, height - 100);
                    
                    ant.play('ant_walk_anim');
                    
                    this.tweens.add({
                        targets: ant,
                        x: targetX,
                        y: targetY,
                        duration: 2000,
                        onComplete: () => {
                            ant.play('ant_idle_anim');
                        }
                    });
                }

                createUI() {
                    const { width } = this.cameras.main;
                    const gameState = this.game.gameState;
                    
                    // Top bar - currencies
                    const uiY = 20;
                    this.foodText = this.add.text(20, uiY, `üåæ Food: ${gameState.currencies.food.toString()}`, {
                        fontSize: '18px',
                        fontFamily: 'Arial',
                        color: '#ffffff',
                        backgroundColor: '#00000088',
                        padding: { x: 10, y: 5 }
                    });
                    
                    this.broodText = this.add.text(20, uiY + 30, `ü•ö Brood: ${gameState.currencies.broodPoints.toString()}`, {
                        fontSize: '16px',
                        fontFamily: 'Arial',
                        color: '#ffffff',
                        backgroundColor: '#00000088',
                        padding: { x: 10, y: 5 }
                    });
                    
                    this.royalJellyText = this.add.text(20, uiY + 55, `üëë Royal Jelly: ${gameState.currencies.royalJelly.toString()}`, {
                        fontSize: '16px',
                        fontFamily: 'Arial',
                        color: '#ffd700',
                        backgroundColor: '#00000088',
                        padding: { x: 10, y: 5 }
                    });
                    
                    // Production rate
                    this.prodText = this.add.text(20, uiY + 80, '', {
                        fontSize: '14px',
                        fontFamily: 'Arial',
                        color: '#90ee90',
                        backgroundColor: '#00000088',
                        padding: { x: 10, y: 5 }
                    });
                    
                    // Click area for food
                    const clickArea = this.add.rectangle(width / 2, 150, 150, 150, 0xffd700, 0.3)
                        .setOrigin(0.5)
                        .setInteractive()
                        .setStrokeStyle(3, 0xffd700);
                    
                    this.add.text(width / 2, 150, 'üåæ\nCLICK FOR FOOD', {
                        fontSize: '24px',
                        fontFamily: 'Arial',
                        color: '#ffffff',
                        align: 'center'
                    }).setOrigin(0.5);
                    
                    clickArea.on('pointerdown', () => {
                        gameState.clickFood();
                        this.showPopupNumber(width / 2, 150, '+1');
                        this.updateUI();
                    });
                    
                    // Shop panels
                    this.createShopUI();
                }

                createShopUI() {
                    const { width, height } = this.cameras.main;
                    const gameState = this.game.gameState;
                    const shopX = width - 320;
                    const shopY = 20;
                    
                    // Shop background
                    this.add.rectangle(shopX + 150, shopY + 200, 280, 380, 0x2a1a0a, 0.9)
                        .setOrigin(0.5, 0)
                        .setStrokeStyle(2, 0x654321);
                    
                    this.add.text(shopX + 150, shopY + 10, 'üè™ SHOP', {
                        fontSize: '20px',
                        fontFamily: 'Arial',
                        color: '#ffd700'
                    }).setOrigin(0.5, 0);
                    
                    // Tabs
                    const tabY = shopY + 40;
                    this.shopTab = 'units';
                    
                    const unitsTab = this.add.text(shopX + 50, tabY, 'UNITS', {
                        fontSize: '14px',
                        fontFamily: 'Arial',
                        color: '#ffffff',
                        backgroundColor: '#654321',
                        padding: { x: 10, y: 5 }
                    }).setInteractive();
                    
                    const roomsTab = this.add.text(shopX + 130, tabY, 'ROOMS', {
                        fontSize: '14px',
                        fontFamily: 'Arial',
                        color: '#888888',
                        backgroundColor: '#3a2a1a',
                        padding: { x: 10, y: 5 }
                    }).setInteractive();
                    
                    unitsTab.on('pointerdown', () => {
                        this.shopTab = 'units';
                        unitsTab.setStyle({ color: '#ffffff', backgroundColor: '#654321' });
                        roomsTab.setStyle({ color: '#888888', backgroundColor: '#3a2a1a' });
                        this.updateShopContent();
                    });
                    
                    roomsTab.on('pointerdown', () => {
                        this.shopTab = 'rooms';
                        roomsTab.setStyle({ color: '#ffffff', backgroundColor: '#654321' });
                        unitsTab.setStyle({ color: '#888888', backgroundColor: '#3a2a1a' });
                        this.updateShopContent();
                    });
                    
                    // Shop content container
                    this.shopContent = this.add.container(shopX + 20, tabY + 40);
                    this.updateShopContent();
                    
                    // Prestige button
                    const prestigeBtn = this.add.text(shopX + 150, height - 40, 'üëë PRESTIGE', {
                        fontSize: '18px',
                        fontFamily: 'Arial',
                        color: '#888888',
                        backgroundColor: '#2a1a0a',
                        padding: { x: 20, y: 10 }
                    }).setOrigin(0.5).setInteractive();
                    
                    prestigeBtn.on('pointerdown', () => {
                        if (gameState.canPrestige()) {
                            if (confirm('Prestige will reset your colony but grant Royal Jelly for permanent bonuses. Continue?')) {
                                gameState.prestige();
                                this.updateUI();
                                this.showPopupNumber(width / 2, height / 2, 'PRESTIGED!', '#ffd700');
                            }
                        }
                    });
                    
                    this.prestigeBtn = prestigeBtn;
                }

                updateShopContent() {
                    const gameState = this.game.gameState;
                    this.shopContent.removeAll(true);
                    
                    let yOffset = 0;
                    
                    if (this.shopTab === 'units') {
                        Object.keys(UNIT_DATA).forEach(unitId => {
                            const data = UNIT_DATA[unitId];
                            const level = gameState.units[unitId].level;
                            const cost = gameState.calculateUnitCost(unitId);
                            const canAfford = gameState.canAffordUnit(unitId);
                            
                            const itemBg = this.add.rectangle(125, yOffset + 35, 240, 60, 0x3a2a1a, 0.8)
                                .setOrigin(0.5)
                                .setStrokeStyle(1, canAfford ? 0x90ee90 : 0x654321);
                            
                            const icon = this.add.text(10, yOffset + 10, data.icon, {
                                fontSize: '24px'
                            });
                            
                            const nameText = this.add.text(40, yOffset + 10, `${data.name} (${level})`, {
                                fontSize: '14px',
                                fontFamily: 'Arial',
                                color: '#ffffff'
                            });
                            
                            const costText = this.add.text(40, yOffset + 30, `Cost: ${cost.toString()} üåæ`, {
                                fontSize: '12px',
                                fontFamily: 'Arial',
                                color: canAfford ? '#90ee90' : '#ff6666'
                            });
                            
                            const prodText = this.add.text(40, yOffset + 45, data.description, {
                                fontSize: '10px',
                                fontFamily: 'Arial',
                                color: '#cccccc'
                            });
                            
                            if (canAfford) {
                                itemBg.setInteractive();
                                itemBg.on('pointerdown', () => {
                                    if (gameState.buyUnit(unitId)) {
                                        this.updateUI();
                                        this.updateShopContent();
                                    }
                                });
                            }
                            
                            this.shopContent.add([itemBg, icon, nameText, costText, prodText]);
                            yOffset += 70;
                        });
                    } else if (this.shopTab === 'rooms') {
                        Object.keys(ROOM_DATA).forEach(roomId => {
                            const data = ROOM_DATA[roomId];
                            const tier = gameState.rooms[roomId].tier;
                            const cost = gameState.calculateRoomCost(roomId);
                            const canAfford = gameState.canAffordRoom(roomId);
                            const maxed = tier >= data.maxTier;
                            
                            const itemBg = this.add.rectangle(125, yOffset + 35, 240, 60, 0x3a2a1a, 0.8)
                                .setOrigin(0.5)
                                .setStrokeStyle(1, maxed ? 0xffd700 : (canAfford ? 0x90ee90 : 0x654321));
                            
                            const icon = this.add.text(10, yOffset + 10, data.icon, {
                                fontSize: '24px'
                            });
                            
                            const nameText = this.add.text(40, yOffset + 10, `${data.name} T${tier}`, {
                                fontSize: '14px',
                                fontFamily: 'Arial',
                                color: '#ffffff'
                            });
                            
                            const costText = this.add.text(40, yOffset + 30, maxed ? 'MAX TIER' : `Cost: ${cost.toString()} üåæ`, {
                                fontSize: '12px',
                                fontFamily: 'Arial',
                                color: maxed ? '#ffd700' : (canAfford ? '#90ee90' : '#ff6666')
                            });
                            
                            const descText = this.add.text(40, yOffset + 45, data.description, {
                                fontSize: '10px',
                                fontFamily: 'Arial',
                                color: '#cccccc'
                            });
                            
                            if (canAfford && !maxed) {
                                itemBg.setInteractive();
                                itemBg.on('pointerdown', () => {
                                    if (gameState.buyRoom(roomId)) {
                                        this.updateUI();
                                        this.updateShopContent();
                                    }
                                });
                            }
                            
                            this.shopContent.add([itemBg, icon, nameText, costText, descText]);
                            yOffset += 70;
                        });
                    }
                }

                updateUI() {
                    const gameState = this.game.gameState;
                    const production = gameState.calculateProduction();
                    
                    this.foodText.setText(`üåæ Food: ${gameState.currencies.food.toString()}`);
                    this.broodText.setText(`ü•ö Brood: ${gameState.currencies.broodPoints.toString()}`);
                    this.royalJellyText.setText(`üëë Royal Jelly: ${gameState.currencies.royalJelly.toString()}`);
                    this.prodText.setText(`‚ö° ${production.foodPerTick.toString()}/tick`);
                    
                    // Update prestige button
                    if (gameState.canPrestige()) {
                        this.prestigeBtn.setStyle({ color: '#ffd700' });
                    } else {
                        this.prestigeBtn.setStyle({ color: '#888888' });
                    }
                    
                    // Spawn more ants as colony grows
                    const totalUnits = Object.values(gameState.units).reduce((sum, u) => sum + u.level, 0);
                    const targetAnts = Math.min(10, 3 + Math.floor(totalUnits / 10));
                    while (this.ants.length < targetAnts) {
                        this.spawnAnts(1);
                    }
                }

                showPopupNumber(x, y, text, color = '#90ee90') {
                    const popup = this.add.text(x, y, text, {
                        fontSize: '20px',
                        fontFamily: 'Arial',
                        color: color,
                        stroke: '#000000',
                        strokeThickness: 2
                    }).setOrigin(0.5);
                    
                    this.tweens.add({
                        targets: popup,
                        y: y - 50,
                        alpha: 0,
                        duration: 1000,
                        onComplete: () => popup.destroy()
                    });
                }

                economyTick() {
                    this.game.gameState.tick();
                    this.updateUI();
                }

                autoSave() {
                    this.game.saveManager.autoSave(this.game.gameState);
                }

                initParticles() {
                    // Initialize tsParticles for ambient effects
                    // Reference: https://particles.js.org/
                    if (typeof tsParticles !== 'undefined') {
                        tsParticles.load('game-container', {
                            particles: {
                                number: {
                                    value: 30,
                                    density: {
                                        enable: true,
                                        value_area: 800
                                    }
                                },
                                color: {
                                    value: '#8b5a3c'
                                },
                                shape: {
                                    type: 'circle'
                                },
                                opacity: {
                                    value: 0.3,
                                    random: true
                                },
                                size: {
                                    value: 2,
                                    random: true
                                },
                                move: {
                                    enable: true,
                                    speed: 0.5,
                                    direction: 'none',
                                    random: true,
                                    straight: false,
                                    out_mode: 'out'
                                }
                            },
                            interactivity: {
                                enable: false
                            },
                            retina_detect: true
                        });
                    }
                }
            }

            // ===== PHASER GAME INITIALIZATION =====
            const config = {
                type: Phaser.AUTO,
                width: window.innerWidth,
                height: window.innerHeight,
                parent: 'game-container',
                backgroundColor: '#3a2a1a',
                scene: [BootScene, TitleScene, ColonyScene],
                scale: {
                    mode: Phaser.Scale.RESIZE,
                    autoCenter: Phaser.Scale.CENTER_BOTH
                },
                physics: {
                    default: 'arcade',
                    arcade: {
                        debug: false
                    }
                }
            };

            const game = new Phaser.Game(config);

            // Handle window resize
            window.addEventListener('resize', () => {
                game.scale.resize(window.innerWidth, window.innerHeight);
            });
        });
    </script>
</body>
</html>
